---
layout: single
title: "스프링과 문제해결 트랜잭션"
categories: [db1]
tags: [db1, TIL]
toc: true
author_profile: true
sidebar:
  nav: "docs"
---

# ☕ Spring 공부 기록

## 📘 학습 날짜
- 2025-08-02

## 📅 오늘 배운 내용

### ✨1. 문제점들

- DB1편의 버전이 낮은 서비스 코드를 보면 서비스가 특정 기술에 종속되어 있는 것을 확인할 수 있다. (SQLException -> JDBC에 의존)
- 트랜잭션은 비즈니스 로직이 있는 서비스 계층에서 사용하는 것이 좋다.
- 트랜잭션을 사용하기위해 DataSource, Connection, SQLException같은 JDBC 기술에 의존한다는 점
- 핵심 비즈니스 로직과 JDBC기술 섞여있어서 유지보수 어렵다.
- 트랜잭션 적용 반복 문제 (try, catch, finally ...)

#### 1-1. 애플리케이션 구조

- 여러가지 구조가 있지만, 가장 단순하면서 많이 사용하는 방법은 역할에 따라 `3가지 계층`으로 나누는 것

- 프리젠테이션 계층
  - 컨트롤러
  - UI와 관련된 처리 담당
  - 웹 요청과 응답
  - 사용자 요청 검증
  - 스프링 MVC기술
- 서비스 계층
  - 비즈니스 로직을 담당
  - 가급적 특정 기술에 의존하지 않고 순수 자바 코드로 작성
- 데이터 접근 계층
  - 실제 데이터베이스에 접근하는 코드
  - JDBC,JPA..
  
- 가장 중요한 곳은 핵심 비즈니스 로직이 들어있는 서비스 계층이다.
- 특정 기술에 종속되지 않게 해야한다.

### ✨2. 스프링의 트랜잭션 추상화

- 서비스 계층이 트랜잭션을 사용하기 위해서 JDBC 기술에 의존하고 있다면?
- 향후 JDBC에서 JPA 같은 다른 데이터 접근 기술로 변경하면, 서비스 계층의 트랜잭션 관련 코드도 모두 함께 수정해야한다.
- 구현 기술마다 트랜잭션 사용법이 다름
- JDBC : `con.setAutoCommit(false)`, JPA : `transaction.begin`
- 이런 문제점을 방지하기 위해 이미 스프링은 트랜잭션을 추상화 해둠.
- `PlatformTransactionManager` 인터페이스를 통해 데이터베이스 접근 기술이 바뀌어도 코드를 모두 수정할 필요없이 주입받아 사용하면 된다.
- DataSourceTransactionManager -> JDBC 트랜잭션 관리, JpaTransactionManager -> Jpa 트랜잭션 관리 등등..
- PlatformTransactionManager 인터페이스 및 구현체를 포함하여 트랜잭션 매니저

### ✨3. 트랜잭션 동기화

- 스프링이 제공하는 트랜잭션 매니저는 2가지 역할
  - 트랜잭션 추상화
  - 리소스 동기화

- 트랜잭션 추상화는 앞서 얘기함.
- 리소스 동기화
  - 트랜잭션 유지하려면 같은 데이터베이스 커넥션 유지 필요. 파라미터로 커넥션 전달하는 방법은 지저분해지고 단점들 존재
  - 스프링은 트랜잭션 동기화 매니저 제공.
  - 동작 방식은 1. 트랜잭션 매니저가 데이터소스를 통해 커넥션 만들고 트랜잭션 시작 2. 트랜잭션 매니저는 트랜잭션 시작된 커넥션 동기화 매니저에 보관 3. 리포지토리는 트랜잭션 동기화 매니저에 보관된 커넥션 사용 4. 트랜잭션이 종료되면 트랜잭션 매니저는 동기화 매니저에 보관된 커넥션 통해 트랜잭션 종료 및 커넥션 닫음

    
### ✨4. 트랜잭션 문제 해결 - 트랜잭션 AOP이해

- 서비스계층에서 트랜잭션을 시작하려면 트랜잭션 관련 코드들이 계속 나오게됨.
- 서비스 계층은 순수한 비즈니스 로직만 두는것이 좋음.
- @Transactional 사용하면 스프링이 AOP사용하여 트랜잭션 편리하게 처리해줌.
- 트랜잭션 프록시를 도입하면, 프록시가 트랜잭션 처리 로직을 모두 가져가고, 트랜잭션을 시작한 후에 프록시가 서비스를 대신 호출한다.
- 그렇기에 서비스 계층에는 순수한 비즈니스 로직만 남길 수 있다.

### ✨5. 스프링 부트의 자동 리소스 등록

- 스프링 부트는 데이터소스를 스프링 빈에 자동으로 등록한다. (dataSource라는 이름으로)
- application.properties파일에 있는 속성 사용하여 생성함. 
- spring.datasource.url=jdbc:h2:tcp://localhost/~/test
- spring.datasource.username=sa 
- spring.datasource.password=
- 트랜잭션 매니저도 자동으로 스프링 빈에 등록함.  JDBC를 사용하면 JDBC매니저를, JPA기술을 사용하면 JPA 매니저를 자동 등록함.