---
layout: single
title: "데이터 접근 기술, 스프링 트랜잭션"
categories: [db2]
tags: [db2, TIL]
toc: true
author_profile: true
sidebar:
  nav: "docs"
---

# ☕ Spring 공부 기록

## 📘 학습 날짜
- 2025-08

## 📅 오늘 배운 내용

### ✨ 1. 데이터 접근 기술들

- JdbcTemplate
- MyBatis
- JPA, Hibernate
- Spring data JPA
- Querydsl

여기에는 2가지 분류가 존재함.

**SQLMapper**
- JdbcTemplate
- MyBatis

**ORM 관련 기술**

- JPA, Hibernate
- Spring data JPA
- Querydsl


**ORM 주요 기능**

- SQLMapper기술은 SQL을 개발자가 직접 작성해야 하지만, JPA를 사용하면 기본적인 SQL은 JPA가 대신 작성하고 처리해준다.
- 개발자는 저장하고 싶은 객체를 자바 컬렉션에 저장하고 조회하듯이 사용하면 ORM 기술이 데이터베이스에 해당 객체를 저장하고 조회해준다.
- Spring Data, Querydsl은 JPA를 더 편리하게 사용할 수 있게 도와주는 프로젝트이다.

---
### ✨ 2. 스프링 트랜잭션 사용 방식

- 선언적 트랜잭션 관리 vs 프로그래밍 방식 트랜잭션 관리
  - 선언적 트랜잭션 관리
    - @Transactional 애노테이션 하나만 선언
  - 프로그래밍 방식의 트랜잭션 관리
    - 트랜잭션 매니저, 트랜잭션 템플릿 등을 사용하여 트랜잭션 관련 코드 직접 작성
- 실무에서는 대부분 선언적 트랜잭션 관리 사용(간편,실용적)

**스프링이 제공하는 트랜잭션 AOP**

- 프록시를 도입하면 트랜잭션 프록시가 트랜잭션 처리 로직을 모두 가져가고, 트랜잭션을 시작한 후에 서비스를 대신 호출한다. 프록시 덕분에 서비스 계층엔 순수한 비즈니스 로직만 남길 수 있다.
- 스프링은 트랜잭션 AOP를 처리하기 위한 모든 기능을 제공한다. 스프링 부트 사용하면 트랜잭션 AOP를 처리하기 위해 필요한 스프링 빈도 자동으로 등록해준다.
- 개발자는 트랜잭션 처리 필요한 곳에 @Transactional 애노테이션만 붙여주면 됨.
---

### ✨ 3. 트랜잭션 AOP 주의 사항 - 프록시 내부 호출

대상 객체의 내부에서 메서드 호출이 발생하면 프록시를 거치지 않고, 대상 객체를 직접 호출하는 문제가 발생한다. <br>
이렇게 되면 @Transactional이 있어도 트랜잭션이 적용되지 않는다.

- 문제 발생 예제 코드는 Github에 있음.
- 간단히 정리하자면 @Transactional을 사용하는 트랜잭션 AOP는 프록시를 사용한다. 프록시를 사용하면 메서드 내부 호출에 프록시를 적용할 수 없다.
- 이 문제를 어떻게 해결할까? 
  - 가장 단순한 방법은 내부 호출을 피하기 위해 메서드를 별도의 클래스로 분리하는 것이다.
  - 예시 코드는 Github에

### ✨ 4. 예외와 트랜잭션 커밋, 롤백

예외가 발생했는데, 내부에서 예외를 처리하지 못하고, 트랜잭션 범위(@Transactional가 적용된 AOP)밖으로 예외를 던진다면?

- 예외 발생시 스프링 트랜잭션 AOP는 예외의 종류에 따라 트랜잭션 커밋하거나 롤백한다.
- 언체크 예외인 RuntimeException, Error와 그 하위 예외가 발생하면 트랜잭션 롤백
- 체크 예외인 Exception과 그 하위 예외가 발생하면 커밋
- 정상 응답하면 트랜잭션 커밋

왜 체크 예외는 커밋하고, 언체크 예외는 롤백할까?
스프링은 기본적으로 체크 예외는 비즈니스 의미가 있을 때 사용하고, 언체크 예외는 복구 불가능한 예외로 가정한다.

- 1. 정상 : 주문시 결제를 성공하면 주문 데이터를 저장하고 결제 상태 완료로 처리
- 2. 시스템 예외 : 주문시 내부에 복구 불가능한 예외가 발생하면 전체 데이터를 롤백
- 3. 비즈니스 예외 : 주문시 결제 잔고가 부족하면 주문 데이터를 저장하고, 결제 상태를 대기로 처리
    - 이 경우 고객에게 잔고 부족을 알리고, 별도의 계좌로 입금하도록 안내
    - 이 예외는 시스템은 정상 동작 했지만, 비즈니스 상황이 예외인 것이다. 이는 매우 중요하고, 반드시 처리해야 하는 경우가 많으므로 체크 예외를 고려할 수 있다.

**정리**

- 비즈니스 문제 상황을 예외를 통해 알려주고, 마치 예외가 리턴 값 처럼 사용된다. 이 경우 롤백하면 생성한 Order 자체가 사라지기 때문에, 잔고 부족을 알리고 별도의 계좌로 입금하도록 안내해도, Order자체가 사라지기 때문에 문제가 된다.
- 체크 예외일때도 롤백하고 싶을 수도 있다. 이때는 rollbackFor 옵션을 사용하면 된다.