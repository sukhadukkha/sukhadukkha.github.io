---
layout: single
title: "영속성 관리"
categories: [jpa]
tags: [jpa]
toc: true
author_profile: true
---

# JPA 영속성 관리 정리

------------------------------------------------------------------------

## 1. JPA의 핵심 개념

-   객체와 관계형 데이터베이스 매핑 (ORM: Object Relational Mapping)
-   **영속성 컨텍스트**: "엔티티를 영구 저장하는 환경"

EntityManager를 통해 영속성 컨텍스트에 접근하며,\
J2SE 환경에서는 1:1, J2EE/스프링 환경에서는 N:1 구조를 가짐.

------------------------------------------------------------------------

## 2. 엔티티 생명주기

-   **비영속 (new/transient)**: 아직 영속성 컨텍스트와 무관한 상태
-   **영속 (managed)**: 영속성 컨텍스트에서 관리되는 상태
-   **준영속 (detached)**: 한 번 영속되었다가 분리된 상태
-   **삭제 (removed)**: 삭제된 상태

``` java
// 비영속
Member member = new Member();
member.setId("member1");
member.setUsername("회원1");

// 영속
EntityManager em = emf.createEntityManager();
em.getTransaction().begin();
em.persist(member); // 영속 상태
```

------------------------------------------------------------------------

## 3. 영속성 컨텍스트의 이점

1.  **1차 캐시**
    -   엔티티 조회 시 DB 접근 대신 캐시에서 먼저 탐색\
2.  **동일성(identity) 보장**
    -   동일한 PK로 조회한 엔티티는 같은 인스턴스로 반환\
    -   REPEATABLE READ 수준의 격리 보장\
3.  **쓰기 지연 (Transactional Write-Behind)**
    -   `persist()` 시 즉시 SQL 실행 X → 커밋 시점에 SQL 실행\
4.  **변경 감지 (Dirty Checking)**
    -   엔티티 속성 변경 시 `update` SQL 자동 생성\
5.  **지연 로딩 (Lazy Loading)**
    -   실제 객체 사용 시점에 쿼리 실행

------------------------------------------------------------------------

## 4. 엔티티 수정과 삭제

-   **수정**

``` java
Member memberA = em.find(Member.class, "memberA");
memberA.setUsername("hi");
memberA.setAge(10);
// 별도 update 코드 없이 commit 시 자동 반영
```

-   **삭제**

``` java
Member memberA = em.find(Member.class, "memberA");
em.remove(memberA);
```

------------------------------------------------------------------------

## 5. 플러시 (Flush)

-   영속성 컨텍스트의 변경 내용을 DB에 동기화
-   발생 시점:
    -   `em.flush()` 직접 호출
    -   트랜잭션 커밋 시 자동 호출
    -   JPQL 실행 시 자동 호출
-   모드:
    -   **AUTO**: 기본값, 커밋/쿼리 실행 시 플러시
    -   **COMMIT**: 커밋할 때만 플러시

------------------------------------------------------------------------

## 6. 준영속 상태

-   영속성 컨텍스트에서 분리된 상태 → 기능 사용 불가
-   만드는 방법:
    -   `em.detach(entity)` 특정 엔티티만 분리
    -   `em.clear()` 전체 초기화
    -   `em.close()` 종료

------------------------------------------------------------------------

## ✅ 핵심 요약

-   JPA의 영속성 컨텍스트는 엔티티 상태를 관리하고 SQL 생성을 자동화함.\
-   이를 통해 **캐시, 동일성 보장, 쓰기 지연, 변경 감지, 지연 로딩**과
    같은 기능을 제공.\
-   개발자는 SQL을 직접 작성하지 않고도 효율적으로 DB와 상호작용 가능.
