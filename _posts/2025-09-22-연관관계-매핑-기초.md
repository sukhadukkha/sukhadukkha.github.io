---
layout: single
title: "연관관계 매핑 기초"
categories: [jpa]
tags: [jpa]
toc: true
author_profile: true
---

# 연관관계 매핑 기초 (JPA)

## 목표
- 객체와 테이블 연관관계의 차이를 이해
- 객체의 참조와 테이블의 외래 키 매핑
- 용어 정리
    - **방향 (Direction):** 단방향, 양방향
    - **다중성 (Multiplicity):** 다대일(N:1), 일대다(1:N), 일대일(1:1), 다대다(N:M)
    - **연관관계의 주인 (Owner):** 양방향 연관관계에서 외래 키를 관리하는 주체

---

## 1. 연관관계가 필요한 이유
- 객체지향 설계 목표: 자율적인 객체들의 협력 공동체
- 테이블은 **외래 키(FK)** 로 조인, 객체는 **참조(Reference)** 로 탐색
- 객체-테이블 간에는 이러한 간극이 존재

### 예제 시나리오
- 회원(Member)과 팀(Team)이 존재
- 회원은 하나의 팀에만 소속됨 → **다대일 관계(N:1)**

---

## 2. 단방향 연관관계

### 기존 방식 (테이블 중심 설계)
```java
@Entity
public class Member {
    @Id @GeneratedValue
    private Long id;

    @Column(name = "USERNAME")
    private String name;

    @Column(name = "TEAM_ID")
    private Long teamId;
}
```
- 단순 FK 값(teamId) 저장
- 협력/탐색 불가능 → 객체지향적이지 않음

### 객체지향 모델링 (참조 사용)
```java
@Entity
public class Member {
    @Id @GeneratedValue
    private Long id;

    private String name;
    private int age;

    @ManyToOne
    @JoinColumn(name = "TEAM_ID")
    private Team team;
}
```
- **참조(team) ↔ 외래 키(TEAM_ID)** 매핑
- `member.setTeam(team);` 으로 관계 설정
- `findMember.getTeam();` 으로 참조 탐색 가능

---

## 3. 양방향 연관관계와 연관관계의 주인

### Member (주인 쪽)
```java
@ManyToOne
@JoinColumn(name = "TEAM_ID")
private Team team;
```

### Team (반대쪽)
```java
@OneToMany(mappedBy = "team")
private List<Member> members = new ArrayList<>();
```

- `mappedBy` → 반대편 필드를 지정하여 주인 아님을 표시
- 주인만 **외래 키 관리(등록/수정)** 가능
- 주인이 아닌 쪽은 읽기 전용

### 주인 설정 원칙
- **외래 키가 있는 쪽**을 주인으로 선택 (여기서는 `Member.team`)

---

## 4. 양방향 매핑 실수 & 해결

❌ 잘못된 예시 (주인 쪽 값 미설정)
```java
team.getMembers().add(member);
em.persist(member);
```
→ `TEAM_ID` 가 `null` 로 저장됨

✅ 올바른 예시
```java
team.getMembers().add(member);
member.setTeam(team);  // 주인 쪽에 반드시 값 설정
em.persist(member);
```

---

## 5. 양방향 매핑 시 주의사항
- 순수 객체 상태 고려 → 항상 양쪽 값 설정
- 편의 메소드 작성 권장
- `toString()`, Lombok, JSON 직렬화 시 **무한 루프** 주의

---

## 6. 정리
- **단방향 매핑만으로도 연관관계 매핑 완료**
- 양방향 매핑은 단순히 **반대 방향 조회 기능 추가**
- JPQL에서 역방향 탐색이 필요할 때만 양방향 매핑 추가
- 연관관계의 주인은 **외래 키 위치**로 결정

---

## 7. 실전 예제
- 테이블 구조: 회원(Member) ↔ 팀(Team)
- 객체 구조: 참조 기반으로 변경하여 ORM 매핑  
