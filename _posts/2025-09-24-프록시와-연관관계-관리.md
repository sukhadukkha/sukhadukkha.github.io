---
layout: single
title: "í”„ë¡ì‹œì™€ ì—°ê´€ê´€ê³„ ê´€ë¦¬"
categories: [jpa]
tags: [jpa, TIL]
toc: true
author_profile: true
sidebar:
  nav: "docs"
---

# í”„ë¡ì‹œì™€ ì—°ê´€ê´€ê³„ ê´€ë¦¬

## ëª©ì°¨
1. í”„ë¡ì‹œ
2. ì¦‰ì‹œ ë¡œë”©ê³¼ ì§€ì—° ë¡œë”©
3. ì§€ì—° ë¡œë”© í™œìš©
4. ì˜ì†ì„± ì „ì´: CASCADE
5. ê³ ì•„ ê°ì²´
6. ì˜ì†ì„± ì „ì´ + ê³ ì•„ ê°ì²´, ìƒëª…ì£¼ê¸°
7. ì‹¤ì „ ì˜ˆì œ â€“ ì—°ê´€ê´€ê³„ ê´€ë¦¬
8. Parentâ€“Child ê´€ê³„ ì„¤ëª…

---

## 1. í”„ë¡ì‹œ

### ê°œë…
- `em.find()` : ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í†µí•´ ì‹¤ì œ ì—”í‹°í‹° ì¡°íšŒ
- `em.getReference()` : ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒë¥¼ ë¯¸ë£¨ê³  í”„ë¡ì‹œ ê°ì²´ ë°˜í™˜

í”„ë¡ì‹œëŠ” ì‹¤ì œ ì—”í‹°í‹°ë¥¼ ìƒì†ë°›ì•„ ë§Œë“¤ì–´ì§€ë¯€ë¡œ **ê²‰ìœ¼ë¡œëŠ” ë™ì¼**í•˜ë‹¤.  
ì²˜ìŒ ì‚¬ìš©í•˜ëŠ” ì‹œì ì—ë§Œ DB ì¡°íšŒê°€ ë°œìƒí•œë‹¤.

```java
Member member = em.getReference(Member.class, "id1");
// ì´ ì‹œì ì—” DB ì¡°íšŒ ì•ˆ í•¨
String name = member.getName(); 
// ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•Œ ì¡°íšŒ ë°œìƒ
```

### íŠ¹ì§•
- í•œ ë²ˆ ì´ˆê¸°í™”ë˜ë©´ ê³„ì† ì‹¤ì œ ì—”í‹°í‹° ì ‘ê·¼ ê°€ëŠ¥
- íƒ€ì… ë¹„êµ ì‹œ `==` ëŒ€ì‹  `instanceof` ì‚¬ìš© í•„ìš”
- ì¤€ì˜ì† ìƒíƒœì—ì„œ ì´ˆê¸°í™”í•˜ë©´ `LazyInitializationException` ë°œìƒ
- ì´ˆê¸°í™” ì—¬ë¶€ í™•ì¸:
  ```java
  PersistenceUnitUtil.isLoaded(member);
  ```
- ê°•ì œ ì´ˆê¸°í™”:
  ```java
  Hibernate.initialize(member);
  ```

---

## 2. ì¦‰ì‹œ ë¡œë”©(EAGER)ê³¼ ì§€ì—° ë¡œë”©(LAZY)

### ì§€ì—° ë¡œë”© (Lazy)
ì—°ê´€ ê°ì²´ëŠ” í”„ë¡ì‹œë¡œ ë‘ê³ , ì‹¤ì œ ì‚¬ìš© ì‹œ ì¡°íšŒí•œë‹¤.

```java
@Entity
public class Member {
    @Id @GeneratedValue
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY) // ì§€ì—° ë¡œë”©
    @JoinColumn(name = "TEAM_ID")
    private Team team;
}
```

```java
Member member = em.find(Member.class, 1L); 
// Teamì€ ì•„ì§ ì¡°íšŒ X
Team team = member.getTeam();
team.getName(); // ì´ ì‹œì ì— Team ì¡°íšŒ ë°œìƒ
```

### ì¦‰ì‹œ ë¡œë”© (Eager)
ì—”í‹°í‹° ì¡°íšŒ ì‹œ í•­ìƒ ì—°ê´€ ì—”í‹°í‹°ë„ í•¨ê»˜ ì¡°íšŒí•œë‹¤.

```java
@Entity
public class Member {
    @Id @GeneratedValue
    private Long id;

    @ManyToOne(fetch = FetchType.EAGER) // ì¦‰ì‹œ ë¡œë”©
    @JoinColumn(name = "TEAM_ID")
    private Team team;
}
```

```java
Member member = em.find(Member.class, 1L); 
// Memberì™€ Teamì„ JOINìœ¼ë¡œ í•¨ê»˜ ì¡°íšŒ
```

âš ï¸ **ì£¼ì˜**: ì¦‰ì‹œ ë¡œë”©ì€ ì˜ˆìƒì¹˜ ëª»í•œ SQLê³¼ N+1 ë¬¸ì œë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.  
ğŸ‘‰ ì‹¤ë¬´ì—ì„œëŠ” **ëª¨ë“  ì—°ê´€ê´€ê³„ë¥¼ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •**í•˜ê³ , í•„ìš”í•œ ê²½ìš° **JPQL fetch join**ì„ ì‚¬ìš©í•œë‹¤.

---

## 3. ì§€ì—° ë¡œë”© í™œìš©
- `Member` â†” `Team` : ìì£¼ í•¨ê»˜ ì‚¬ìš© â†’ Fetch Join í™œìš©
- `Member` â†” `Order` : ê°€ë” ì‚¬ìš© â†’ Lazy
- `Order` â†” `Product` : ìì£¼ í•¨ê»˜ ì‚¬ìš© â†’ Fetch Join

**ì‹¤ë¬´ ì›ì¹™**
- ê¸°ë³¸ì€ **ëª¨ë“  ì—°ê´€ê´€ê³„ Lazy**
- í•„ìš”í•  ë•Œë§Œ `fetch join` ë˜ëŠ” `ì—”í‹°í‹° ê·¸ë˜í”„` ì‚¬ìš©

---

## 4. ì˜ì†ì„± ì „ì´: CASCADE

### ê°œë…
íŠ¹ì • ì—”í‹°í‹°ë¥¼ ì˜ì†í™”í•  ë•Œ **ì—°ê´€ëœ ì—”í‹°í‹°ë„ í•¨ê»˜ ì˜ì†í™”**í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•œë‹¤.  
(ì—°ê´€ê´€ê³„ ë§¤í•‘ê³¼ëŠ” ë³„ê°œ)

```java
@OneToMany(mappedBy = "parent", cascade = CascadeType.PERSIST)
private List<Child> children = new ArrayList<>();
```

```java
Parent parent = new Parent();
Child child1 = new Child();
parent.getChildren().add(child1);

em.persist(parent); // child1ë„ í•¨ê»˜ ì €ì¥ë¨
```

### CASCADE ì¢…ë¥˜
- `ALL`: ëª¨ë‘ ì ìš©
- `PERSIST`: ì˜ì†
- `REMOVE`: ì‚­ì œ
- `MERGE`: ë³‘í•©
- `REFRESH`: ìƒˆë¡œê³ ì¹¨
- `DETACH`: ë¶„ë¦¬

---

## 5. ê³ ì•„ ê°ì²´

### ê°œë…
ë¶€ëª¨ì™€ ì—°ê´€ê´€ê³„ê°€ ëŠì–´ì§„ ìì‹ ì—”í‹°í‹°ë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œí•œë‹¤.

```java
@OneToMany(mappedBy = "parent", orphanRemoval = true)
private List<Child> children = new ArrayList<>();

Parent parent = em.find(Parent.class, id);
parent.getChildren().remove(0); 
// ìì‹ì´ ê³ ì•„ ê°ì²´ê°€ ë˜ì–´ DBì—ì„œ DELETE ì‹¤í–‰
```

### ì£¼ì˜
- ë‹¤ë¥¸ ê³³ì—ì„œ ì°¸ì¡°í•˜ì§€ ì•Šì„ ë•Œë§Œ ì‚¬ìš©
- ê°œì¸ ì†Œìœ  ê´€ê³„ì¼ ë•Œë§Œ ì‚¬ìš©
- `@OneToOne`, `@OneToMany`ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥

---

## 6. ì˜ì†ì„± ì „ì´ + ê³ ì•„ ê°ì²´ = ìƒëª…ì£¼ê¸° ê´€ë¦¬

```java
@OneToMany(mappedBy = "parent", cascade = CascadeType.ALL, orphanRemoval = true)
private List<Child> children = new ArrayList<>();
```

- ë¶€ëª¨ ì—”í‹°í‹°ë¥¼ í†µí•´ ìì‹ì˜ **ìƒëª…ì£¼ê¸° ê´€ë¦¬ ê°€ëŠ¥**
- DDDì—ì„œ `Aggregate Root` êµ¬í˜„ì— ì í•©

---

## 7. ì‹¤ì „ ì˜ˆì œ â€“ ì—°ê´€ê´€ê³„ ê´€ë¦¬

### ê¸€ë¡œë²Œ ì „ëµ
- ëª¨ë“  ì—°ê´€ê´€ê³„ë¥¼ Lazyë¡œ ì„¤ì •
- `@ManyToOne`, `@OneToOne`ë„ Lazyë¡œ ê°•ì œ ì„¤ì •

### ì˜ì†ì„± ì „ì´ í™œìš©
- `Order â†’ Delivery` : `CascadeType.ALL`
- `Order â†’ OrderItem` : `CascadeType.ALL`

```java
@Entity
public class Order {
    @OneToOne(cascade = CascadeType.ALL)
    private Delivery delivery;

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderItem> orderItems = new ArrayList<>();
}
```

---

## 8. Parentâ€“Child ê´€ê³„ ì„¤ëª…

```java
@OneToMany(mappedBy = "parent", orphanRemoval = true)
private List<Child> children = new ArrayList<>();
```

- Parent ì…ì¥ â†’ `OneToMany`: ë¶€ëª¨ í•˜ë‚˜ê°€ ì—¬ëŸ¬ ìì‹ì„ ê°€ì§
- Child ì…ì¥ â†’ `ManyToOne`: ìì‹ í•˜ë‚˜ê°€ ë¶€ëª¨ í•˜ë‚˜ì— ì†í•¨

ì¦‰, **Parent 1 : N Child** ê´€ê³„ë‹¤.

Child ìª½ ë§¤í•‘ ì˜ˆì‹œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤:

```java
@ManyToOne
@JoinColumn(name = "parent_id")
private Parent parent;
```

ë”°ë¼ì„œ ParentëŠ” One, ChildëŠ” Manyì— í•´ë‹¹í•œë‹¤.  
ì´ ì½”ë“œëŠ” "ë¶€ëª¨ í•˜ë‚˜ê°€ ì—¬ëŸ¬ ìì‹ì„ ì†Œìœ "í•˜ëŠ” ê´€ê³„ë¥¼ í‘œí˜„í•œë‹¤.
