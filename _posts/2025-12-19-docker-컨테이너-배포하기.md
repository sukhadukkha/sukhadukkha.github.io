---
layout: single
title:  "Docker 컨테이너 배포하기(1)"
categories: [docker]
tags: [docker]
toc: true
author_profile: true
---

## EC2 인스턴스 만들고 접속해보기

**영상 보고 정리 내용 정리**

- 인스턴스 만들기, 키 페어 생성하기
- SSH로 원격 컴퓨터 접속하기
- 도커 설치 및 로컬에서 빌드한 이미지 원격으로 가져오기 
- 보안그룹 설정하기

원격에 도커 설치 명령어
```
# 1. 시스템의 패키지를 최신 상태로 업데이트
sudo yum update -y

# 2. 도커 설치 (yum -y install docker가 한 줄로 이어져야 합니다)
sudo yum install -y docker

# 3. 도커 서비스 시작
sudo service docker start

# 4. ec2-user에게 도커 실행 권한 부여 (매번 sudo 안 붙여도 되게 함)
sudo usermod -a -G docker ec2-user

# 5. 로그아웃 하고 다시 로그인 하고 다음 명령 실행
sudo systemctl enable docker
```

## 로컬 이미지 원격으로 가져가기
- 2가지 방법 존재
- 1. 소스 코드 배포하고 원격에서 이미지 빌드하기(복잡함)
- 2. 로컬 머신에서 이미지 빌드하고 구축된 이미지 원격에 배포하기(보통 이 방법 사용)
- Docker Hub에 이미지 Push하기
  - Create Repository on Docker Hub
  - .dockerignore file에 node_modules, Dockerfile, *.pem 등 민감하고 무거워지는 파일 등록
  - 로컬 터미널에서 docker build -t node-dep-example-1 . 
  - docker tag node-dep-example-1 \<내 Docker Hub 이름 저장소\>로 이미지 이름 변경
  - docker login으로 Docker Hub에 로그인
  - docker push \<위에서 변경한 이미지 이름\> 통해 Docker Hub에 이미지 Push

- 원격으로 Docker Hub에서 이미지 Pull 하기
  - Public 이미지이기 때문에 Login 할 필요 없음 
  - sudo docker run -d --rm -p 80:80 \<원격 저장소 이미지 이름\>
  - 나중에 명령어를 바꿔서 사용


## 원격에서 컨테이너 테스트하기 

- AWS에 입력되어있는 IP 사용 및 보안 그룹 설정 필요
  - 이유는? EC2는 기본적으로 WWW의 모든것과 연결되어 있지 않음. SSH를 사용하는 사용자 외에는 아무도 연결 불가능

- `인바운드, 아웃바운드란?`
  - 인바운드 : 밖에서 안으로 들어오는 규칙
  - 아웃바운드 : 안에서 밖으로 나가는 규칙(EC2 기본 설정은 모든 아웃바운드 허용)

- 테스트 하려면 인바운드 규칙 설정 필요
  - HTTP 요청을 받을 수 있도록 80포트 열어주기(보안 규칙 업데이트)
  - 이렇게 설정하고 브라우저에 IPv4 입력하면 애플리케이션 동작
- **원격에서 아무런 도구도 설치하지 않고 소스코드도 없이 Docker만을 사용하여 애플리케이션이 동작한다.**

- docker-compose 파일이 있다면, 원격에서 실행 할 수도 있다.

## 코드 업데이트는 어떻게 할까? 

- 코드 변경 후 자동으로 원격에 반영되지는 않는다.
- 업데이트를 원격으로 반영하려면?
  - 이미지를 로컬에서 재 빌드하고, Docker Hub에 push 한 후, 다시 원격에서 실행시키면 된다.
  - `여기서 중요한 점은 만약 이미지가 로컬에 있다면, 그 이미지를 사용하기 때문에 최신 Docker Hub의 원격 이미지를 반영하지는 않는다.`
  - 이를 해결하기 위해서는 `docker pull` 명령으로 이미지를 다시 가져오면 된다.

- 하지만 이게 최종적인 배포 방법은 아니다! 해결은? 다음 글