---
layout: single
title:  "Kubernetes 시작하기"
categories: [Kubernetes]
tags: [Kubernetes]
toc: true
author_profile: true
---


## Kubernetes란 ? 

- 컨테이너 배포에 도움이 되는 도구 및 작업 방법을 모아놓은 시스템이다.
- 오픈소스 시스템이자 컨테이너 배포 관리, 오케스트레이션하기 위한 표준이다.
- 구성 파일, 배포할 컨테이너, 인스턴스 수, 스케일 확장해야 하는지, 교체해야 하는지 등을 설정할 수 있다.
- 특정 도구를 사용하여 이 구성을 클라우드 Provider 혹은 우리의 머신에 전달할 수 있다.
- 특정 Provider에 특화된 옵션을 구성 파일에 병합할 수 있다.
- K8s는 클라우드 Provider가 아닌, 오픈 소스이고, 모든 Provider와 함께 사용할 수 있는 개념의 모음이자 소프트웨어의 모음이다.
- K8s는 배포용 Docker Compose와 걑다.

---

## 컨테이너 수동 배포의 문제점

- 컨테이너 충돌 시 새 컨테이너로 교체해야하는 문제
  - 수동으로 모니터링 하고, 수동으로 교체해야한다.
  - 하루종일 로그만 보고 있을 수는 없다.
- 트래픽 급증시 더 많은 컨테이너 인스턴스 필요
  - 줄어들면 다시 컨테이너 인스턴스 줄이기 필요
- HTTP 트래픽에 대해서도 컨테이너 인스턴스에 균등하게 분산 필요
- **이러한 문제는 ECS와 같은 서비스로 해결 할 수 있다. 그런데 왜 Kubernetes일까?**

---

## 왜 Kubernetes 인가?

- ECS의 단점
  - ECS라는 서비스에 고정된다 (AWS에서만 AWS에서 정의한 방식으로만 사용 가능)
  - 다른 Provider에서 사용하려면 그 Provider의 정보와 서비스를 다시 학습해야한다.
- 이를 표준 컨테이너 오케스트레이션 Kubernetes를 통해 어떤 Provider에서도 동작하는 환경을 구성할 수 있다.
- 또한 더욱 정교한 기능을 사용할 수 있다.
  - 마이크로서비스 간 통신 정교하게 제어 가능
  - 원하는 기능 직접 프로그래밍하여 넣을 수 있음
  - K8s를 도와주는 오픈소스 도구들을 사용 가능

---

## Kubernetes 아키텍처 & 핵심 개념

- 컨테이너는 Pod라는 것에 의해 관리된다.
  - Pod는 K8s의 가장 작은 단위이다.
  - 구성 파일에서 정의할 수 있다.
- 내부에 컨테이너가 있는 Pod는 Worker 노드에서 자신을 실행한다.
  - Worker 노드는 컨테이너를 실행하는 도구이다. (머신, 가상 인스턴스, ECS 인스턴스라고 생각)
  - 특정 양의 CPU와 메모리가 있는 어딘가의 컴퓨터. 이 안에서 Pod 실행
  - 동일한 Worker 노드 중 하나에서 둘 이상의 Pod 실행 가능
  - 하나 이상의 Worker 노드 필요 (포드와 컨테이너 실행 할 장소는 하나 이상 무조건 필요하다)
- 프록시
  - Worker 노드에서 Worker 노드의 포드 네트워크 트래픽 제어를 설정하는 도구
  - 이러한 포드가 인터넷에 연결할 수 있는지 여부와 포드 및 그 내부에서 실행되는 컨테이너를 외부 세계에서 어떻게 접근할 수 있는지 제어한다.
- 트래픽이 증가하고 감소함에 따라 Pod는 쿠버네티스에 의해 Worker 노드로 자동으로 배포된다.
- 이러한 Worker 노드와 이 노드에서 실행되는 포드 및 컨테이너를 제어하기 위해 포드를 만들고 시작하고, 교체하거나 종료해야한다.
  - **이러한 작업은 마스터 노드에 의해 호출되는 컨트롤 plane에 의해 수행된다.**
  - 이는 Worker 노드와 상호작용하여 제어하는 컨트롤 센터이다.
- 이 모든것이 클러스터를 형성하고, 모든 부분이 연결된 하나의 네트워크를 형성한다.
- 마스터 노드는 클라우드 Provider API에 요청을 보내, 그 클라우드 Provider의 특정 리소스를 생성하고, 이 상태를 복제하도록 지시한다.

![구조](/assets/images/K8sArchitecutre.png)

- K8s를 사용하기 전에 K8s를 실행할 수 있는 환경 제공 필요
  - 클러스터와 Worker 노드, K8s가 설치되고 작업을 수행하는 마스터 노드를 만들고 설정해야한다.
- K8s는 이러한 리소스를 설정하지 않지만, 이런 리소스가 주어지면 이러한 포드를 관리하고 생성하고 자동으로 배포하고 모니터링하고 실패하면 다시 시작하거나 하는 다양한 작업을 수행한다.
- **K8s는 클러스터를 생성하지 않는다. 그저 사용할 뿐이다.**

---

## Worker 노드 알아보기

- **이 노드는 예를들어 어딘가에서 실행 중인 ec2 인스턴스이다.**
- 또한 마스터 노드에서 관리하고, 내부에 Pod가 존재한다.
- Pod는 하나 이상의 애플리케이션 컨테이너와 컨테이너에 속한 모든 리소스를 호스팅한다.
- 이 Pod 자체도 마스터 노드에 의해 즉 K8s에 의해 관리된다.
  - K8s는 Pod를 생성하거나 삭제할 수 있다.
  - 하나의 Pod에 하나의 컨테이너가 있지만, 밀접하게 작동해야 하는 여러 컨테이너가 있는 경우에는 포드 내부에 여러 컨테이너 가질 수 있다.
  - 볼륨같은 추가 리소스가 존재할 수도 있다.
- Worker 노드에 둘 이상의 포드가 실행되는 것이 일반적이다.
  - 다른 포드의 복사본일 수 있다.
  - 스케일링 하고, 하나의 동일한 컨테이너에서 여러 인스턴스를 실행하여 트래픽 분산하는 경우
  - 완전히 다른 작업을 수행하기 위한 내부에 다른 컨테이너가 존재하는 포드일 수 도 있다.
- 이 안에는 몇가지 추가 소프트웨어도 존재한다.
  - 컨테이너 생성 및 Pod에 필요한 Docker
  - Worker 노드와 마스터 노드 간의 통신 장치인 kubelet
  - 트래픽을 처리하고, 허용된 트래픽만이 포드에 접근하고, 워커 노드를 떠날 수 있게 하는 kube-proxy,
- AWS와 같은 클라우드 Provider를 사용하는 경우 이 쿠버네티스 정의를 제공할 수 있는 서비스가 존재한다.
  - AWS가 모든 인스턴스를 설정하고 필요한 모든 소프트웨어를 설치한다.
  - 단지 그 안에서 무슨 일이 일어나는지 알기만 하면 된다.

![구조](/assets/images/workerNode.png)

---

## 마스터 노드 알아보기

- 마스터 노드 내부에 있는 가장 중요한 소프트웨어는 API 서버이다.
  - Worker 노드에서 실행되는 kubelet 서비스에 대한 카운터 포인트인 마스터 노드 머신에서 실행된느 간단한 서비스다.
  - 이것은 워커와 마스터 노드간의 통신을 위한 카운터 파트다.
- 포드를 관찰하고 새 포트가 생성되어야 하는 워커 노드를 선택하는 일을 담당하는 Scheduler
  - 포드의 비정상 상태, 다운, 스케일링을 위해 새로운 포드 생성 필요한 경우
  - 워커 노드에 무엇을 알려야 하는지 API 서버에 알리는 역할
- 워커 노드 전체를 감시하고 제어하며 적당한 수의 포드를 가동 중에 있는지 확인하는 Kube-Controller-Manager
- 클라우드 Provider마다 다른 Cloud-Controller-Manager
  - 사용중인 Provider가 무엇이든 명령을 번역해준다.

![구조](/assets/images/masterNode.png)


--- 

## 중요 용어 & 개념

- Cluster 
  - 노드 머신, 마스터노드, 워커 노드 등 최종 상태를 구성하는 모든것의 세트
- Nodes 
  - 하나 또는 여러개의 포드를 호스팅하는 특정 하드웨어 용량을 가지며, 클러스터와 통신하거나 클러스터 내에서 통신하는 물리적인 머신 또는 가상 머신이다.
  - 모든 워커 노드를 거쳐 포드를 관리하는 컨트롤 plane을 가진 마스터 노드가 있고, Pod를 호스팅하는 Worker 노드도 있다.
- Pods
  - 컨테이너를 감싼 껍질이다.
  - 컨테이너를 시작하여 컨테이너를 관리한다. 
  - 마스터 노드에 의해 관리된다.
  - 포드가 생성되는 것은 포드에서 컨테이너를 실행하는 것과 같다.
- Containers 
  - 일반적인 Docker 컨테이너
  - 포드는 컨테이너를 실행하기 위해 내부적으로 docker run 명령을 실행한다.
- Services 
  - 포드 및 컨테이너에 독립적인 IP 주소를 가진 포드 그룹이다.
  - 서비스는 포드에 접근하는데 중요하고, 그 안에 존재하는 컨테이너도 중요하다.
  - 프록시와 관련이 있다.
  - 특정 Pod를 외부 세계에 노출하고, 특정 IP 주소 또는 도메인으로 특정 Pod에 연결할 수 있도록 하는 용어이다. 