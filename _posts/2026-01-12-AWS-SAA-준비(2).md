---
layout: single
title:  "AWS SAA 준비(EC2, SSH)"
categories: [AWS SAA]
tags: [AWS SAA]
toc: true
author_profile: true
---



## EC2란?

- Elastic Compute Cloud의 약자로, 원격의 가상 컴퓨터 한대를 빌려주는 것이다.
- 강의 보고 실습해본 부분
  - EC2 인스턴스 생성
  - 생성 중, 고급 세부 정보에서 User data 스크립트 적용 가능
- Public IP는 인스턴스가 중지되고 다시 시작되면 바뀐다.
- EC2 인스턴스의 보안에 들어가서 IAM Role을 부여할 수 있다.
- EC2 인스턴스 종류

| 유형 | 패밀리 (Family) | 특징 및 용도 | 비유 |
|------|-----------------|--------------|------|
| General Purpose | T, M | CPU, 메모리, 네트워크 성능이 균형 잡힘. 웹 서버, 개발 환경 등 | 일반 승용차 |
| Compute Optimized | C | 강력한 CPU 성능 위주. 고성능 웹 서버, 배치 처리, 비디오 인코딩 | 스포츠카 |
| Memory Optimized | R, X, High Mem | 많은 양의 RAM 제공. 고성능 DB(MySQL, PostgreSQL), 캐시(Redis) | 대형 버스 |
| Storage Optimized | I, D, H | 로컬 스토리지의 읽기/쓰기 속도가 매우 빠름. NoSQL, 데이터웨어하우스 | 덤프트럭 |
| Accelerated Computing | P, G, F | GPU 또는 전용 가속기 포함. 딥러닝(AI), 그래픽 렌더링 | 특수 장비차 |


### EC2 User Data

- 인스턴스가 처음 새성되어 부팅될 때 딱 한 번 자동으로 실행되는 스크립트이다.
- 왜 사용할까?
  - 인스턴스를 만들 때마다 일일이 원격 접속(SSH)해서 웹 서버를 깔고 코드를 설정하는 건 매우 번거롭습니다. User Data를 사용하면 인스턴스가 시작되자마자 다음과 같은 작업을 자동으로 완료할 수 있다.
  - `이를 부트스트래핑(Bootstrapping) 이라고 한다.`
  - OS 패치 및 업데이트, 웹 서버, DB 설치 등...
  - 스크립트 내용이 너무 많으면 서비스가 준비되기까지 시간이 걸릴 수 있다.

## SSH (Port 22)

- 다른 컴퓨터에 로그인하거나 원격으로 명령을 실행할 수 있게 해주는 보안 프로토콜이다.
- AWS의 EC2 인스턴스에 원격으로 명령을 실행할 수 있게 하기 위해 사용한다.
- 모든 통신이 암호화 되어있다.
- 인바운드 규칙 22번 포트 열려있어야 한다.
- 사용하는 방법
  - .pem 키 파일이 있는 디렉터리에서 
  - `chmod 400 [키 파일 이름].pem` 명령을 통해 .pem 파일에 대대 나에게만 읽기 권한을 허용해준다.(소유자(4:R) - 그룹(0) - 기타 사용자(0)) 
  - `ssh -i [키 파일 이름].pem ec2-user@[EC2 Public IP]` 명령을 통해 접속 가능

## EC2 구매 옵션

- **On-Demand**
  - 약정 없이 사용한 만큼 초 단위로 지불하는 방식.
  - 가장 유연하고, 언제든지 생성하고 삭제 가능
  - 중단하면 안되는 중요한 작업, 앱의 사용량을 예측할 수 없을 때
- **Reserved instances(RI)**
  - 1년 또는 3년 기간을 약정하여 온디맨드 대비 최대 72% 할인 받는 방식
  - Standard RI: 할인율 높지만 중간에 사양 변경 어려움.
  - Convertible RI: 할인율 낮지만 인스턴스 패밀리나 OS 등을 변경할 수 있는 유연함 가지고 있음.
  - 꾸준하고 예측 가능한 워크로드 (ex: 24시간 켜두는 DB 서버)
- **Saving Plans**
  - RI와 비슷하게 1/3년 약정을 하지만, 특정 인스턴스 타입이 아닌 시간당 지출 금액을 약정한다.
  - RI보다 훨씬 유연하고, 인스턴스 타입을 바꿔도, 람다나 Fargate로 서비스를 옮겨도 할인 혜택이 유지된다.
  - 사양이 바뀔 가능성이 있는 장기 프로젝트에 고려한다.
- **Spot Instances**
  - AWS의 남는 자원을 경매 방식으로 빌려 사용하며 최대 90% 저렴하다.
  - AWS가 자원이 필요해지면 2분 전 예고 후 인스턴스를 회수 해버린다.
  - 중단되어도 상관없는 작업(빅데이터 분석, 이미지 렌더링, 테스트용 서버)에 고려한다.
- **Dedicated Hosts**
  - 물리적인 서버 한 대를 통째로 나만 사용하는 방식
  - 가장 비쌈
  - 기업의 강력한 보안 규정 준수가 필요할 때 등 고려한다.
- **비용 절감과 중단 기능이 동시에 나오면 Spot Instance / 1년 이상 꾸준히는 RI, Saving Plans**

| 옵션 | 키워드 | 가성비 | 특징 |
|------|--------|--------|------|
| On-Demand | 유연함, 단기, 예측불가 | 낮음 | 약정 없음, 즉시 사용 가능 |
| Reserved | 고정, 장기, 1/3년 | 높음 | 꾸준한 사용량, 특정 사양 예약 |
| Savings Plans | 유연한 약정, 현대적 | 높음 | 금액 기반 약정, 서비스 전환 가능 |
| Spot | 최저가, 중단 가능 | 최고 | 언제든 꺼질 수 있음, 비핵심 업무 |
| Dedicated | 물리적 고립, 라이선스 | 최저 | 가장 비쌈, 하드웨어 제어 가능 |


- Capacity Reservations 추가 및 표 정리

| 구분 | 목적 | 약정 기간 | 자원 확보 (Capacity) |
|------|------|-----------|----------------------|
| Savings Plans | 비용 할인 (최고) | 1년 또는 3년 | 보장 안 됨 |
| Reserved Instance (Regional) | 비용 할인 | 1년 또는 3년 | 보장 안 됨 |
| Reserved Instance (Zonal) | 비용 할인 + 자원 확보 | 1년 또는 3년 | 보장 됨 (지정 AZ 내) |
| Capacity Reservation | 자원 확보 (전용) | 없음 (언제든 삭제) | 보장 됨 (무조건) |



## Spot Instance 요청

- 일회성 요청 : 요청이 수락되어 인스턴스가 한 번 생성되면 요청 자체가 사라진다. 이 경우에는 인스턴스만 종료해도 끝난다.
- 영구적 요청 : 이 요청은 내가 설정한 대상 용량을 유지하려고 노력한다. 따라서 인스턴스만 종료하면 AWS는 인스턴스가 없어졌으니 새 인스턴스를 더 만들어버린다.
- 영구적 요청으로 생성된 인스턴스를 완전히 없애려면 다음 순서를 지킨다.
  - 1.스팟 요청 취소 : 먼저 '주문서' 자체를 파기한다.
  - 2.인스턴스 종료 : 실행 중인 인스턴스를 종료한다.
- 스팟 인스턴스의 상태 변화

| 상태 | 설명 |
|---------|------|
| Open | 요청이 제출되었으나 아직 인스턴스가 생성되지 않음 |
| Active | 인스턴스가 정상적으로 생성되어 실행중임. |
| Disabled  | 영구 요청을 잠시 멈춘 상태 (다시 활성화 가능) |
| Cancelled | 요청이 취소됨 (더 이상 새 인스턴스가 생기지 않음) |

## Spot Fleet
 
- 내가 설정한 Target Capacity를 맞추기 위해 여러 종류의 스팟 인스턴스를 자동으로 섞어서 띄워주는 서비스다.
- Spot Pool을 활용한다. 
  - 스팟 풀 예시: t3.micro + ap-northeast-2a 조합은 하나의 풀입니다. t3.small + ap-northeast-2a는 또 다른 풀입니다.
- 왜 사용하나?
  - 중단 위험 분산: 하나의 인스턴스 타입만 쓰다가 AWS가 회수해가면 서비스가 죽지만, 스팟 플릿은 여러 타입을 섞어 쓰기 때문에 하나가 죽어도 나머지가 살아있어 안정적입니다.
  - 자동 복구: 특정 인스턴스가 회수되면, 스팟 플릿이 즉시 다른 사용 가능한 스팟 풀에서 새 인스턴스를 찾아내어 목표 용량을 다시 채웁니다.
  - 비용 최적화: 내가 정한 예산 범위 내에서 가장 저렴한 조합을 알아서 찾아줍니다.

- Target Capacity(목표 용량) : 플릿이 유지해야 하는 인스턴스 수 또는 가중치 단위의 합계 / Target Capacity를 채우기 위해 On-Demand 와 Spot을 섞을 수 있다.
  - 수량 기반 : 인스턴스 개수로 설정(목표용량 = 5대)
  - 성능 기반 : 인스턴스 마다 성능이 다를 때 가중치를 준다. (ex CPU 2개 2점, 4개 4점, 총합 20점 유지해줘)
- 인스턴스가 AWS에 의해 회수되어 현재 용량이 Target Capacity보다 낮아지면, 현 플릿은 새 인스턴스를 자동으로 요청한다.
- **할당 전략 - 중요!**

| 전략 | 특징 | 추천 상황 |
|------|------|-----------|
| lowestPrice | 가장 가격이 낮은 스팟 풀에서만 인스턴스를 선택 | 무조건 비용 절감이 최우선일 때 |
| diversified | 선택한 모든 스팟 풀에 골고루 분산하여 인스턴스를 생성 | 가용성(안정성)이 중요할 때 (하나의 풀이 끊겨도 영향이 적음) |
| capacityOptimized | 용량이 넉넉해 중단될 확률이 가장 낮은 스팟 풀을 우선 선택 | 인스턴스가 자주 종료되면 안 되는 작업 |
| priceCapacityOptimized | (기본값) 가격과 용량을 균형 있게 고려하여 스팟 풀을 선택 | 일반적인 대부분의 상황 |


- 스팟 인스턴스 vs 스팟 플릿 비교

| 구분 | 스팟 인스턴스 (단일) | 스팟 플릿 (Spot Fleet) |
|------|--------------------|-----------------------|
| 관리 단위 | 개별 인스턴스 요청 | 인스턴스들의 집합 (Fleet) |
| 유연성 | 특정 사양 1개만 요청 가능 | 여러 사양(t2, t3, m5 등) 혼합 가능 |
| 목표 용량 | 개념 없음 | "난 항상 10대 수준의 성능을 유지해줘" 설정 가능 |


- 정리
  - 스팟 풀 : [인스턴스 유형 + 가용 영역(AZ)]의 조합으로 결정됨.
  - ex: 풀 A: t3.micro 사양 + 서울 리전 a구역(ap-northeast-2a) / 풀 B: t3.micro 사양 + 서울 리전 c구역(ap-northeast-2c) / 풀 C: m5.large 사양 + 서울 리전 a구역(ap-northeast-2a)
  - AWS 데이터 센터 안에는 수많은 물리 서버가 있고, 구역마다 남는 사양의 컴퓨터가 제각각입니다. 따라서 풀 A는 자원이 널널해서 쌀 수 있지만, 풀 B는 자원이 부족해서 비싸거나 아예 없을 수도 있습니다.
  - Diversified
    - 상황: 내 목표 용량이 10대이고, 내가 선택한 후보 스팟 풀이 5개라고 가정합시다.
    - 작동 방식: diversified 전략을 쓰면, 각 풀마다 2대씩(10대 ÷ 5개 풀) 공평하게 인스턴스를 생성합니다.
    - 왜 이렇게 하나요? (안정성): 만약 특정 구역에 갑자기 사용자가 몰려서 풀 A가 중단되어야 한다면, 나는 10대 중 2대만 잃고 8대는 여전히 유지할 수 있습니다. 반면, lowestPrice 전략을 썼다면 가장 싼 풀 A에 10대를 다 몰아넣었다가 한꺼번에 10대를 모두 잃을 수도 있습니다.
  - Capacity Optimized
    - 작동 방식: AWS는 현재 자기네 데이터 센터에서 어떤 사양의 컴퓨터가 가장 많이 놀고(여유 자원) 있는지 실시간으로 알고 있습니다.
    - 비유: "지금 1인석은 꽉 찼는데, 단체석(m5.large)은 자리가 엄청 많네? 그럼 단체석으로 안내해줄게. 여기가 나중에 비켜달라고 할 확률이 제일 낮거든!"이라고 추천해주는 방식입니다.
    - 장점: 중단(회수)이 거의 발생하지 않아 서비스 연속성이 매우 높습니다.
  - 중단은 왜 될까?
    - 집주인 (온디맨드 사용자): "나 지금 정가 내고 t3.micro 100대 쓸 거야!"라고 요청합니다.
    - AWS: 온디맨드 사용자는 정가를 내는 귀한 손님이므로 무조건 자원을 내줘야 합니다.
    - 현실: 그런데 데이터 센터에 남는 컴퓨터가 없습니다.
    - 강제 퇴거 (중단): AWS는 90%나 할인받아 쓰고 있던 스팟 인스턴스 사용자에게 "2분 뒤에 컴퓨터 뺄 거니까 정리해!"라고 통보하고 자원을 회수해서 온디맨드 사용자에게 줍니다.