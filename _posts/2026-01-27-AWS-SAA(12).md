---
layout: single
title:  "AWS SAA 준비(ECS,EKS,App Runner,App2Container,Lambda)"
categories: [AWS SAA]
tags: [AWS SAA]
toc: true
author_profile: true
---


## ECS, EKS, App Runner, App2Container는 정리 생략

- Amazon ECS Task Role
  - 컨테이너 단위로 IAM 권한 분리


## AWS Lambda

- 서버를 프로비저닝하거나 관리할 필요 없이 코드를 실행할 수 있게 해주는 서버리스(Serverless) 컴퓨팅 서비스다.
- 핵심 작동 원리: 이벤트 기반 아키텍처
  - Lambda는 스스로 실행되지 않는다. 특정 사건(Event)이 발생했을 때만 깨어나서 동작한다.
  - 트리거 (Trigger): S3에 파일이 업로드되거나, API Gateway에 요청이 들어오는 등의 이벤트가 발생한다.
  - 함수 실행 (Execution): 설정한 메모리와 런타임 환경에서 코드가 실행된다.
  - 결과 반환 (Response): 작업 완료 후 결과를 반환하거나 다른 서비스(DB, SNS 등)로 데이터를 넘긴다.
- 주요 특징
  - 서버리스 (Serverless): OS 패치, 서버 업데이트, 용량 확장 등 하드웨어 및 소프트웨어 관리를 AWS가 전담한다.
  - 오토 스케일링 (Auto-scaling): 요청 횟수에 따라 자동으로 확장된다. 요청이 없으면 0개, 많으면 수천 개까지 함수 인스턴스가 생성된다.
  - 비용 효율성: 코드가 실행되는 시간(밀리초 단위)과 호출 횟수에 대해서만 비용을 지불한다. 실행되지 않을 때는 비용이 0원이다.
  - 유연한 언어 지원: Node.js, Python, Java, Go, Ruby, C# 등을 지원하며, 커스텀 런타임을 통해 원하는 언어를 사용할 수 있다.
- 기술적 제약 사항 (주의점)
  - Cold Start: 한동안 호출되지 않다가 처음 호출될 때 실행 환경을 준비하느라 지연(Latency)이 발생할 수 있다. (Java 같은 무거운 언어에서 두드러진다.)
  - Stateless: 함수는 실행 후 사라지므로 데이터를 로컬에 저장할 수 없다. 데이터 보존은 외부 DB(RDS, DynamoDB)나 S3를 이용해야 한다.
  - 일시적 저장 공간: /tmp 디렉토리에 최대 10GB의 임시 공간을 제공하지만, 영구적이지 않다.
  - 제한 시간: 한 번 실행될 때 최대 15분까지만 허용된다.


### Lambda Concurrency


- Lambda Concurrency
  - 특정 시점에 AWS Lambda 함수가 동시에 처리하고 있는 활성 요청의 수를 의미한다.
  - 동시성의 세 가지 유형
    - `비예약 동시성 (Unreserved Concurrency)`
      - 개념: 별도의 설정을 하지 않았을 때 리전 내의 모든 함수가 공유하는 기본 풀(Pool)이다.
      - 특징: 기본적으로 리전당 1,000으로 설정되어 있다. 특정 함수가 트래픽 폭주로 이 풀을 다 써버리면 다른 함수들이 실행되지 못하는 'Neighbors 노이즈' 문제가 발생할 수 있다.
    - `예약 동시성 (Reserved Concurrency)`
      - 개념: 특정 함수가 사용할 수 있는 최대 동시성 수치를 미리 할당해두는 것이다.
      - 효과
        - 자원 보장: 다른 함수의 트래픽과 상관없이 해당 함수가 쓸 자원을 확보한다.
        - 처리량 제한: 특정 함수가 너무 많은 자원을 써서 DB에 과부하를 주는 것을 방지하는 'Throttling' 용도로도 쓰인다.
        - 주의: 예약된 수치만큼 비예약 풀에서 자원이 빠져나간다.
    - `가용 동시성 (Provisioned Concurrency)`
      - 개념: 실행 환경을 미리 초기화(Pre-warm)해두는 방식이다.
      - 효과: Lambda의 고질적인 문제인 Cold Start(콜드 스타트)를 해결한다. 요청이 들어오자마자 즉시 실행되어야 하는 실시간 서비스에 필수적이다.
      - 비용: 함수 실행 여부와 상관없이 할당된 시간 동안 비용이 발생한다.
- 스로틀링(Throttling)과 오류 처리
  - 동시성 한도에 도달하면 람다는 추가 요청을 거부하며 429 Too Many Requests 오류를 발생시킨다.
  - 동기식 호출 (API Gateway 등): 호출자에게 즉시 429 오류를 반환한다.
  - 비동기식 호출 (S3, SNS 등): 람다가 자동으로 재시도를 수행하며, 최대 6시간 동안 이벤트를 보관한다.
  - 스트림 기반 호출 (Kinesis, DynamoDB 등): 데이터가 만료될 때까지 재시도한다.


## Lambda@Edge

- Amazon CloudFront의 기능 중 하나로, 전 세계 AWS 엣지 로케이션에서 사용자에게 더 가까운 곳에서 코드를 실행할 수 있게 해주는 서버리스 컴퓨팅 서비스다.
- 일반 람다가 특정 리전(서울, 버지니아 등)에 상주하며 동작한다면, Lambda@Edge는 전 세계에 퍼져 있는 CloudFront 엣지 로케이션으로 복제되어 사용자 바로 옆에서 동작한다.
- 4가지 트리거 시점 (The 4 Events)
  - Lambda@Edge는 CloudFront가 요청을 주고받는 과정 중 특정 시점에 개입한다. 이 4가지 시점을 구분하는 것이 SAA 시험과 실무 설계의 핵심이다.
  - Viewer Request: 사용자가 CloudFront에 요청을 보낼 때 실행된다. (캐싱 확인 전)
  - Origin Request: CloudFront에 캐시가 없어서 원본 서버(S3, ALB 등)로 요청을 보낼 때 실행된다.
  - Origin Response: 원본 서버가 응답을 보내고 CloudFront가 이를 받았을 때 실행된다. (캐싱 전)
  - Viewer Response: CloudFront가 사용자에게 최종 응답을 보내기 직전에 실행된다.
- 주요 활용 사례 (Use Cases)
  - 보안 및 인증: 엣지에서 요청을 검사하여 유효하지 않은 요청을 즉시 차단하거나, JWT 토큰 인증을 수행한다.
  - A/B 테스팅: 사용자 속성에 따라 다른 오리진으로 요청을 라우팅하거나 응답을 변경한다.
  - 동적 콘텐츠 생성: 원본 서버까지 가지 않고 람다 내에서 HTML을 생성하여 사용자에게 즉시 응답한다.
- 기술적 제약 및 주의 사항
  - 버지니아 북부(us-east-1) 리전: Lambda@Edge 함수는 반드시 us-east-1 리전에서 생성해야 한다. 여기서 생성된 함수가 전 세계 엣지로 복제되는 구조다.
  - 제한적인 런타임: 표준 람다와 달리 지원하는 런타임이 Node.js와 Python으로 제한적이다.
- **Lambda@Edge vs CloudFront Functions**

| 구분 | CloudFront Functions | Lambda@Edge |
|---|---|---|
| 실행 위치 | 엣지 로케이션 (Edge Location) | 리전별 엣지 캐시 (Regional Edge Cache) |
| 트리거 시점 | Viewer Request / Viewer Response만 가능 | 4가지 시점 모두 가능 |
| 성능 / 지연 시간 | 마이크로초 단위 (매우 빠름) | 밀리초 단위 |
| 최대 실행 시간 | 1ms 이내 | 5초 ~ 30초 |
| 프로그래밍 언어 | JavaScript (ES 5.1 기반) | Node.js, Python |
| 네트워크 접근 | 불가능 | 가능 (외부 API 호출 등) |
| 패키지 크기 | 최대 10KB | 최대 50MB |


## Lambda in VPC

![구조](/assets/images/LambdaWithRDSProxy.png)

- RDS Proxy에 Lambda가 접근하려면 같은 VPC 내에 있어야함. 
- RDS Proxy에는 Public 접근이 불가하기 때문이다.


## RDS-Invoking Lambda & Event Notification

- Amazon RDS는 단순히 데이터를 저장하는 기능을 넘어, 데이터의 변화나 인프라의 상태 변화를 감지하여 외부 로직(주로 AWS Lambda)을 실행할 수 있는 강력한 통합 기능을 제공한다.
- RDS에서 Lambda 직접 호출 (Invoking Lambda)
  - 주로 Amazon Aurora에서 강력하게 지원하며, 최근 표준 RDS(MySQL, PostgreSQL)에서도 지원이 확대되었다.
  - 작동 원리
    - 트리거 발생: DB 내 특정 테이블에 INSERT나 UPDATE가 발생한다.
    - 프로시저 실행: 미리 작성된 SQL 트리거가 AWS 람다를 호출하는 내장 함수를 실행한다.
    - 데이터 전달: 변경된 행(Row)의 데이터를 JSON 형태로 람다에 전달한다.
  - 주요 활용 사례
    - 실시간 데이터 가공: 새로운 사용자가 가입하면 DB 트리거가 람다를 호출하여 웰컴 이메일을 발송한다.
    - 외부 시스템 동기화: DB 데이터가 변경될 때마다 ElasticSearch나 외부 API에 실시간으로 알림을 보낸다.
    - 사기 탐지 (Fraud Detection): 비정상적인 거래 데이터가 입력되면 즉시 람다를 실행하여 분석 로직을 돌린다.
- RDS 이벤트 알림 (Event Notifications)
  - 이 기능은 데이터베이스 내부의 데이터가 아니라, RDS 인프라 자체의 상태 변화를 감지하여 알림을 보내는 방식이다. Amazon SNS와 연동되어 작동한다.
  - 작동 원리
    - 이벤트 발생: RDS 인스턴스에서 스냅샷 완료, 장애 조치(Failover), 재부팅, 파라미터 그룹 변경 등의 사건이 발생한다.
    - SNS 전달: RDS가 설정된 SNS 주제(Topic)로 이벤트를 게시한다.
    - 후속 조치: SNS를 구독하고 있는 Lambda, SQS, 이메일, HTTP 엔드포인트 등이 이를 받아 처리한다.
  - 주요 활용 사례
    - 운영 자동화: DB 장애 조치(Failover)가 발생하면 람다를 통해 슬랙(Slack)으로 관리자에게 알림을 보낸다.
    - 보안 모니터링: 누군가 DB 파라미터 그룹이나 보안 그룹을 변경하면 즉시 경고를 발생시킨다.
- 클라우드 엔지니어를 위한 설정 주의사항
  - IAM 권한: RDS 인스턴스가 Lambda를 호출할 수 있는 권한(lambda:InvokeFunction)이나 SNS에 게시할 수 있는 권한을 가진 IAM Role을 생성하여 RDS 인스턴스에 반드시 연결해야 한다.
  - 네트워크 (VPC): RDS는 보통 프라이빗 서브넷에 위치한다. 람다를 호출하려면 RDS가 위치한 VPC에 Lambda용 인터페이스 VPC 엔드포인트가 있거나, NAT Gateway를 통해 외부 AWS API 엔드포인트로 나갈 수 있어야 한다.

![구조](/assets/images/InvokingLambda.png)
![구조](/assets/images/EventNotificiaton.png)


