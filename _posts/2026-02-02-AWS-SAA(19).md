---
layout: single
title:  "AWS SAA 준비(CIDR, Private IP, Public IP, VPC, Subnet,IGW, Route Table, Bastion Host, NAT Gateway, NACL)"
categories: [AWS SAA]
tags: [AWS SAA]
toc: true
author_profile: true
---


## AWS Networking – VPC 기초 정리
(CIDR / Private IP vs Public IP / VPC)

---

## 1. CIDR (Classless Inter-Domain Routing)

### 개요
- IP 주소 범위를 표현하는 방식
- VPC 및 Subnet의 IP 범위를 정의할 때 사용

### 형식
10.0.0.0/16

- `10.0.0.0` : 네트워크 시작 주소
- `/16` : 네트워크로 고정된 비트 수

### CIDR 크기 예시

| CIDR | 전체 IP 개수 |
|----|-------------|
| /16 | 65,536 |
| /24 | 256 |
| /28 | 16 |

* AWS에서는 각 서브넷마다 5개 IP가 예약됨

### 시험 포인트
- VPC CIDR는 사설 IP 대역만 사용 가능
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
- CIDR가 겹치면 VPC Peering 불가

---

## 2. Private IP vs Public IP

### Private IP
- 내부 네트워크 통신용 IP
- 인터넷에서 직접 접근 불가
- VPC 내부 리소스 간 통신에 사용

#### 사설 IP 대역
- 10.0.0.0 ~ 10.255.255.255
- 172.16.0.0 ~ 172.31.255.255
- 192.168.0.0 ~ 192.168.255.255

---

### Public IP
- 전 세계에서 유일한 IP
- 인터넷에서 직접 접근 가능
- AWS에서 자동 할당 또는 Elastic IP 사용

---

### 핵심 차이

| 구분 | Private IP | Public IP |
|----|-----------|-----------|
| 인터넷 접근 | 불가 | 가능 |
| VPC 내부 통신 | 가능 | 가능 |
| 외부 접근 | 불가 | 가능 |
| 비용 | 무료 | 조건부 과금 |

### 시험 포인트
- EC2 인스턴스는 항상 Private IP를 가짐
- Public IP는 선택 사항
- 인터넷 접근을 위해 Public IP 또는 ALB 필요

---

## 3. VPC (Virtual Private Cloud)

### 개요
- AWS 안에 생성하는 논리적으로 격리된 가상 네트워크
- IP 대역, 라우팅, 보안 설정을 사용자가 직접 제어

---

### VPC 주요 구성 요소
- CIDR Block
- Subnet
- Route Table
- Internet Gateway
- Security Group
- Network ACL

---

### VPC 기본 구조
VPC (10.0.0.0/16)<br>
├─ Public Subnet<br>
└─ Private Subnet

- 서브넷은 가용 영역(AZ) 단위로 생성

---

### 핵심 개념 정리
- VPC는 리전 단위 리소스
- 서브넷은 AZ 단위 리소스
- 퍼블릭/프라이빗 서브넷 구분은 라우트 테이블 차이

---

## 한 줄 요약
- CIDR은 IP 범위 표현 방식
- EC2는 항상 Private IP를 가진다
- VPC는 AWS에서 만드는 나만의 네트워크


---

## AWS Subnet 정리

---

## 1. Subnet 개요

- **VPC 안에서 IP를 나눈 작은 네트워크 단위**
- 각 Subnet은 **단일 가용 영역(AZ)** 안에 생성
- VPC CIDR 내에서 고유한 IP 범위를 가짐

### 특징
- AZ 단위 배치
- IP 범위는 VPC CIDR의 일부
- 퍼블릭/프라이빗 여부는 **라우트 테이블**과 IGW 연결로 결정

---

## 2. Subnet CIDR

- Subnet 생성 시 VPC CIDR 안에서 일부 범위를 할당
- 예시<br>
  VPC CIDR: 10.0.0.0/16<br>
  Subnet 1: 10.0.0.0/24<br>
  Subnet 2: 10.0.1.0/24<br>

- **/24 → 256 IP**, AWS 예약 5개 → 실제 사용 가능 IP: 251개

### 시험 포인트
- 서브넷 CIDR는 **VPC CIDR 범위를 벗어나면 안 됨**
- 서로 겹치면 Subnet 생성 불가

---

## 3. 퍼블릭 서브넷 vs 프라이빗 서브넷

| 구분 | 퍼블릭 서브넷 | 프라이빗 서브넷 |
|------|---------------|----------------|
| 인터넷 접근 | 가능 | 불가 |
| Route Table | IGW 연결 | IGW 없음 |
| 용도 | ALB, Bastion Host | EC2 Backend, RDS |
| 특징 | 외부 통신 직접 가능 | 외부 통신은 NAT 필요 |

### 퍼블릭 서브넷 구성
- Route Table에 **Internet Gateway 경로** 존재
- EC2에 Public IP 할당 가능

### 프라이빗 서브넷 구성
- Route Table에 IGW 경로 없음
- 외부와 통신하려면 NAT Gateway 필요

---

## 4. 서브넷 설계 원칙

1. **가용 영역 단위**
- 다중 AZ 설계 필수
2. **CIDR 범위 계획**
- VPC CIDR 내 겹치지 않게 나누기
3. **역할 기반 구분**
- 퍼블릭 → 외부 노출 리소스
- 프라이빗 → 내부/백엔드 리소스
4. **확장 고려**
- IP 부족 방지를 위해 충분한 범위 할당

---

## 5. Subnet과 라우팅

- Subnet은 **라우트 테이블과 연결되어야 인터넷 접근 가능 여부 결정**
- 기본 구조:
  VPC<br>
  ├─ Public Subnet → Route Table → IGW → 인터넷<br>
  └─ Private Subnet → Route Table → NAT → IGW → 인터넷<br>


---

## 6. 시험 포인트 정리

- 퍼블릭 서브넷 = IGW 연결 + 외부 접근 가능
- 프라이빗 서브넷 = NAT 필요 + 외부 직접 접근 불가
- AZ 단위로 Subnet 생성
- Subnet CIDR는 VPC CIDR 내에서만 가능
- AWS는 서브넷마다 **5개 IP 예약**

---

## 한 줄 요약
- **Subnet = VPC 안의 작은 네트워크, AZ 단위 배치, 퍼블릭/프라이빗 여부는 라우팅으로 결정**


---

# AWS 네트워크 핵심 개념: IGW, Route Table, Bastion Host

---

## 1. Internet Gateway (IGW)

### 개요
- VPC와 인터넷 사이의 **게이트웨이 역할**을 하는 통신 관문
- 퍼블릭 IP를 가진 인스턴스가 인터넷과 통신 가능

### 특징
- **수평 확장 및 고가용성**: AWS가 관리, 대역폭 제한이나 단일 장애 지점(SPOF) 걱정 없음
- **VPC와 1:1 연결**: 하나의 VPC에는 하나의 IGW만 연결(Attach) 가능
- **양방향 통신**: 외부 → 내부, 내부 → 외부 모든 트래픽 처리

### 시험 포인트
- IGW는 생성 후 **반드시 VPC에 Attach**해야 사용 가능
- 인스턴스가 인터넷 사용 시
  - **퍼블릭 IP** 필요
  - 해당 서브넷의 **라우트 테이블에 IGW 경로** 필요

---

## 2. Route Table (RT)

### 개요
- 네트워크 트래픽이 어디로 갈지 결정하는 **규칙(Route) 집합**
- 서브넷/게이트웨이가 이 표지판을 보고 데이터 전달

### 구성 요소
- **Destination**: 패킷이 가야 하는 IP 범위 (예: `0.0.0.0/0`)
- **Target**: 패킷을 전달할 게이트웨이/인터페이스 (예: `igw-xxxx`, `nat-xxxx`)
- **Local Route**: VPC 내부 통신을 위한 자동 생성 규칙 (삭제 불가)

### 라우트 테이블 종류
- **Main Route Table**: VPC 생성 시 기본 생성
- **Custom Route Table**: 특정 서브넷을 위해 사용자가 직접 생성

### 시험 포인트
- 서브넷은 **하나의 라우트 테이블에 반드시 연결**
  - 연결 없으면 Main RT 사용
- **퍼블릭 서브넷**: `0.0.0.0/0` 대상 → IGW

---

## 3. Bastion Host

### 개요
- **프라이빗 서브넷 리소스 접속용 EC2**
- 관리자가 내부 서버에 접속하는 **징검다리 역할**
- 퍼블릭 서브넷에 위치

### 보안 설계 원칙
- **최소 권한**: 특정 IP(Home/Office)에서 오는 SSH/RDP만 허용
- **인스턴스 보호**: 프라이빗 인스턴스 보안 그룹은 Bastion Host SG만 허용

### 최신 기술
- **AWS Systems Manager (SSM) Session Manager** 추천
  - 22번 포트 열지 않고 웹/CLI로 안전 접속 가능

---

## 4. 핵심 요약 비교

| 구성 요소 | 역할 | 위치 | 비고 |
|-----------|------|------|------|
| IGW       | 인터넷 통신 관문 | VPC 레벨 | 1:1 연결, 고가용성 |
| Route Table | 트래픽 경로 제어 | 서브넷 레벨 | Local 경로 항상 포함 |
| Bastion Host | 내부 서버 관리 접속 | 퍼블릭 서브넷 | 보안 그룹 관리가 핵심 |

---

## 한 줄 요약
**IGW는 대문, Route Table은 표지판, Bastion Host는 관리자 전용 통로**


---


## AWS NAT Gateway 정리

---

## 1. NAT Gateway 개요

- **프라이빗 서브넷 리소스가 인터넷으로 나갈 수 있게 해주는 서비스**
- 외부에서 프라이빗 리소스로 **직접 접근은 불가능**
- 단방향 통신(Outbound Only)

---

## 2. 왜 NAT Gateway가 필요한가?

### 문제 상황
- 프라이빗 서브넷의 EC2는 Public IP가 없음
- Internet Gateway는 퍼블릭 서브넷에서만 직접 사용 가능

### 해결
- 퍼블릭 서브넷에 NAT Gateway 배치
- 프라이빗 서브넷은 NAT Gateway를 통해 인터넷 접근

---

## 3. NAT Gateway 동작 흐름

Private EC2<br>
↓<br>
Private Subnet Route Table<br>
(0.0.0.0/0 → NAT Gateway)<br>
↓<br>
NAT Gateway (Public Subnet)<br>
↓<br>
Internet Gateway<br>
↓<br>
Internet
<br>

- 응답 트래픽은 기존 연결에 한해서만 허용
- 외부 → 내부 신규 연결은 차단

---

## 4. NAT Gateway 구성 조건

- 퍼블릭 서브넷에 생성
- Elastic IP 필요
- 반드시 Internet Gateway가 VPC에 연결되어 있어야 함

---

## 5. NAT Gateway vs NAT Instance

| 항목 | NAT Gateway | NAT Instance |
|------|-------------|--------------|
| 관리 | AWS 관리형 | 직접 관리 |
| 가용성 | 자동 확장 | 수동 구성 |
| 성능 | 높음 | 인스턴스 성능 의존 |
| 보안 | SG 불가 | SG 가능 |
| 비용 | 사용량 기반 | EC2 비용 |

### 시험 포인트
- **운영 부담 최소화 → NAT Gateway**
- NAT Instance는 레거시 선택지

---

## 6. 고가용성 설계 (중요)

- NAT Gateway는 **AZ 단위 리소스**
- 각 AZ마다 NAT Gateway 생성 권장
- 프라이빗 서브넷은 **같은 AZ의 NAT Gateway 사용**

---

## 7. 시험 단골 시나리오

- 프라이빗 서브넷 EC2가
  - OS 업데이트
  - 패키지 다운로드
  - 외부 API 호출

→ **NAT Gateway**

---

## 8. 자주 나오는 오답 포인트

- NAT Gateway는 외부에서 접근 가능 ❌
- NAT Gateway는 프라이빗 서브넷에 생성 ❌
- 보안 그룹 적용 가능 ❌

---

## 한 줄 요약
- **NAT Gateway = 프라이빗 서브넷의 인터넷 출구**

---


## AWS Network ACL (NACL) + Ephemeral Ports

---

## 1. NACL 개요

- **Subnet 단위에서 동작하는 네트워크 방화벽**
- 인바운드 / 아웃바운드 트래픽을 제어
- VPC 생성 시 기본 NACL 자동 생성

---

## 2. NACL 핵심 특징

- Subnet에 적용
- Stateless (무상태)
- Allow / Deny 규칙 모두 지원
- 규칙 번호(Rule Number) 기반 평가

---

## 3. Stateless 의미 (중요)

- 인바운드 허용 ≠ 응답 허용
- 응답 트래픽도 **아웃바운드 규칙에 명시적으로 허용 필요**

---

## 4. Ephemeral Ports (임시 포트)

### 개요
- 클라이언트가 **짧은 시간 동안 사용하는 임시 포트**
- 주로 응답 트래픽에 사용

### AWS Ephemeral Port 범위
- `1024 ~ 65535`

---

## 5. NACL에서 Ephemeral Ports가 중요한 이유

### 상황 예시
- EC2가 HTTP 요청 (Port 80) 전송
- 서버 응답은 **Ephemeral Port**로 돌아옴

Outbound: EC2 → Internet (Dst Port 80)<br>
Inbound: Internet → EC2 (Dst Port 1024~65535)<br>


👉 NACL에서 Ephemeral Port를 허용하지 않으면  <br>
**응답 패킷이 차단됨**<br>

---

## 6. 올바른 NACL 설정 예시

### 인바운드 규칙
- Allow TCP 80
- Allow TCP 1024–65535

### 아웃바운드 규칙
- Allow TCP 80
- Allow TCP 1024–65535

---

## 7. 흔한 장애 원인 (시험 단골)

- 인바운드 80 허용
- 아웃바운드 Ephemeral Port 미허용 ❌
- 결과: 웹 페이지 접속 실패

---

## 8. NACL vs Security Group + Ephemeral Ports

| 항목 | NACL | Security Group |
|------|------|----------------|
| 상태 | Stateless | Stateful |
| Ephemeral Port 설정 | 필요 | 자동 처리 |
| 응답 트래픽 | 명시적 허용 | 자동 허용 |

---

## 9. 언제 특히 중요?

- NACL 사용 시 항상 고려
- 프라이빗 서브넷 아웃바운드 통신
- 외부 API 호출 / 패키지 업데이트

---

## 시험 포인트 정리

- NACL은 Stateless → Ephemeral Port 허용 필수
- Security Group은 Stateful → 자동 처리
- 응답이 안 오면 포트 범위 확인

---

## 한 줄 요약
- **NACL + Ephemeral Ports 설정 안 하면 통신은 나가고 응답은 막힌다**

---

## NACL & Security Group 실습 정리 (강의 실습 + Outbound 개념)

---

## 실습 시나리오 개요

- Bastion Host 역할의 EC2 생성
- httpd 실행 → "Hello World" 웹 서버
- Public IP로 HTTP(80) 접속
- NACL, Security Group 규칙 변경하며 동작 확인

---

## 실습 1. Security Group만 설정한 상태

### 설정
- Security Group
  - Inbound: TCP 80 허용
  - Outbound: 기본 Allow
- NACL: 기본 NACL (모두 허용)

### 결과
- 웹 서버 정상 접속

### 이유
- Security Group은 Stateful
- Inbound 요청 허용 → 응답 자동 허용

---

## 실습 2. NACL Inbound에 80 허용

### 설정
- NACL Inbound: TCP 80 허용
- NACL Outbound: Allow
- Security Group: Inbound 80 허용

### 결과
- 웹 서버 정상 접속

### 이유
- 요청(80 포트) 통과
- 응답(Ephemeral Port)도 Outbound에서 허용됨

---

## 실습 3. NACL Outbound에서 0.0.0.0/0 Deny

### 설정
- NACL Inbound: TCP 80 허용
- NACL Outbound: ❌ 0.0.0.0/0 Deny
- Security Group: Inbound 80 허용

### 결과
- 웹 서버 접속 실패

### 실제 네트워크 흐름
1. 클라이언트 → 웹서버
  - Src: Ephemeral Port
  - Dst: 80
  - Inbound 허용 ⭕

2. 웹서버 → 클라이언트 (응답)
  - Src: 80
  - Dst: Ephemeral Port
  - Outbound ❌ 차단

### 핵심 원인
- NACL은 Stateless
- 응답 트래픽도 Outbound 규칙 필요
- Ephemeral Port 차단 → 응답 불가

---

## 실습 4. NACL 허용 + Security Group Outbound 삭제

### 설정
- NACL Inbound/Outbound: 허용
- Security Group
  - Inbound: TCP 80 허용
  - Outbound: ❌ 전부 삭제

### 결과
- 웹 서버 정상 동작

### 이유
- Security Group은 Stateful
- Inbound로 시작된 연결의 응답은 자동 허용
- Outbound SG 규칙 없어도 응답 가능

---

## 추가 개념 실습 확장: EC2가 외부 API를 호출하는 경우

### 상황
- EC2가 외부 API 또는 다른 EC2의 API 호출
  - 결제 API
  - 인증 서버
  - 다른 마이크로서비스

EC2 → External API (Request)<br>
External API → EC2 (Response)<br>


### 이 경우의 핵심
- **연결을 EC2가 먼저 시작**
- EC2는 서버가 아니라 **클라이언트 역할**

---

## 외부 API 호출 시 필요한 설정

### Security Group
- Outbound 허용 ⭕ (필수)
- Inbound 응답은 자동 허용 (Stateful)

### NACL
- Outbound: 대상 포트 허용
- Inbound: Ephemeral Port 허용

---

## 정리: 언제 Outbound가 필요한가?

| 상황 | Outbound SG 필요 |
|----|----------------|
| 외부에서 웹 요청 수신 | ❌ |
| ALB 뒤에서 응답만 수행 | ❌ |
| EC2가 외부 API 호출 | ⭕ |
| EC2 → 다른 EC2 API 호출 | ⭕ |

---

## 핵심 개념 요약

- Security Group
  - Stateful
  - 요청 허용 시 응답 자동 허용
- NACL
  - Stateless
  - 요청/응답 모두 명시적 허용 필요
- Ephemeral Port
  - 응답 트래픽에 필수

---

## 시험 대비 한 줄 요약

- 요청만 받는 서버 → Inbound만 있어도 OK
- 서버가 먼저 나가면 → Outbound 필요
- 응답이 안 오면 → NACL + Ephemeral Port 확인

---

## 실습 흐름

- VPC 생성 10.0.0.0/16
- VPC 안에 Private Subent 2개(10.0.16.0/20, 10.0.32.0/20), Public Subnet 2개 생성(10.0.0.0/24, 10.0.1.0/24)
- EC2 인스턴스 생성(Public Subnet에)
- Public Subnet에 생성한 인스턴스에서 외부 인터넷으로 통신 불가
- 해결하기 위해 VPC 내에 Internet Gateways 생성, Route Table 생성하고 Route Table에 Public Subnet 추가
- Route Table에 0.0.0.0/0 -> IGW route 설정
- 이제 Private Subnet에 EC2 인스턴스 만들고 인터넷 연결 해보기
- EC2 -> NAT Gateway -> IGW 경로 필요
- Public Subent에 Elastic IP 할당받아 NAT Gateway 생성하기
- Private Route Table 0.0.0.0/0 -> Nat Gateway로 라우트 설정
- 현재까지 아키텍쳐

![구조](/assets/images/NATGateway.png)


